
> @google/gemini-cli-core@0.21.0-nightly.20251219.70696e364 test:ci
> vitest run


 RUN  v3.2.4 /home/profharita/Code/termAI/packages/core
      Coverage enabled with v8

 âœ“ src/mcp/token-storage/keychain-token-storage.test.ts (29 tests) 322ms
 âœ“ src/policy/config.test.ts (19 tests) 465ms
 âœ“ src/mcp/token-storage/file-token-storage.test.ts (16 tests) 714ms
 âœ“ src/tools/ripGrep.test.ts (51 tests | 1 skipped) 415ms
 âœ“ src/tools/grep.test.ts (24 tests) 209ms
 âœ“ src/services/shellExecutionService.test.ts (50 tests | 1 skipped) 709ms
 âœ“ src/mcp/oauth-provider.test.ts (34 tests) 1265ms
   âœ“ MCPOAuthProvider > authenticate > should handle invalid callback request  1003ms
 âœ“ src/tools/ls.test.ts (21 tests) 209ms
 âœ“ src/tools/shell.test.ts (27 tests | 1 skipped) 268ms
 âœ“ src/tools/confirmation-policy.test.ts (8 tests) 292ms
 âœ“ src/telemetry/clearcut-logger/clearcut-logger.test.ts (45 tests) 346ms
 âœ“ src/tools/edit.test.ts (56 tests) 274ms
 âœ“ src/tools/mcp-client.test.ts (55 tests) 435ms
 âœ“ src/core/coreToolScheduler.test.ts (38 tests) 372ms
 âœ“ src/services/loopDetectionService.test.ts (47 tests) 274ms
 âœ“ src/tools/read-many-files.test.ts (31 tests) 344ms
 âœ“ src/tools/read-file.test.ts (29 tests) 217ms
 âœ“ src/config/config.test.ts (119 tests) 182ms
 âœ“ src/tools/write-file.test.ts (31 tests) 189ms
 âœ“ src/utils/filesearch/fileSearch.test.ts (27 tests) 106ms
 âœ“ src/utils/memoryDiscovery.test.ts (29 tests) 166ms
 âœ“ src/tools/mcp-tool.test.ts (43 tests) 106ms
 âœ“ src/utils/pathReader.test.ts (18 tests) 113ms
 â¯ src/core/client.test.ts (56 tests | 1 failed | 1 skipped) 673ms
   âœ“ Gemini Client (client.ts) > addHistory > should call chat.addHistory with the provided content 12ms
   âœ“ Gemini Client (client.ts) > resetChat > should create a new chat session, clearing the old history 5ms
   Ã— Gemini Client (client.ts) > startChat > should include environment context when resuming a session 25ms
     â†’ expected 'This is TermAI, a general terminal agâ€¦' to contain 'This is the Gemini CLI'
   âœ“ Gemini Client (client.ts) > tryCompressChat > when compression inflates the token count > allows compression to be forced/manual after a failure 7ms
   âœ“ Gemini Client (client.ts) > tryCompressChat > when compression inflates the token count > yields the result even if the compression inflated the tokens 5ms
   âœ“ Gemini Client (client.ts) > tryCompressChat > when compression inflates the token count > does not manipulate the source chat 6ms
   â†“ Gemini Client (client.ts) > tryCompressChat > when compression inflates the token count > will not attempt to compress context after a failure
   âœ“ Gemini Client (client.ts) > tryCompressChat > should correctly latch hasFailedCompressionAttempt flag 5ms
   âœ“ Gemini Client (client.ts) > tryCompressChat > should not trigger summarization if token count is below threshold 5ms
   âœ“ Gemini Client (client.ts) > tryCompressChat > should return NOOP if history is too short to compress 6ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > emits a compression event when the context was automatically compressed 9ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > does not emit a compression event when the status is 2 5ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > does not emit a compression event when the status is 4 5ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should include editor context when ideMode is enabled 6ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should not add context if ideMode is enabled but no open files 7ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should add context if ideMode is enabled and there is one active file 7ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should add context if ideMode is enabled and there are open files but no active file 6ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should use local estimation for text-only requests and NOT call countTokens 6ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should use countTokens API for requests with non-text parts 7ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should estimate CJK characters more conservatively (closer to 1 token/char) 6ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should return the turn instance after the stream is complete 7ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should stop infinite loop after MAX_TURNS when nextSpeaker always returns model 19ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should yield MaxSessionTurns and stop when session turn limit is reached 7ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should respect MAX_TURNS limit even when turns parameter is set to a large value 29ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should yield ContextWindowWillOverflow when the context window is about to overflow 11ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should use the sticky model's token limit for the overflow check 12ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should not trigger overflow warning for requests with large binary data (PDFs/images) 12ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Model Routing > should use the model router service to select a model on the first turn 21ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Model Routing > should use the same model for subsequent turns in the same prompt (stickiness) 11ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Model Routing > should reset the sticky model and re-route when the prompt_id changes 13ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should use getGlobalMemory for system instruction when JIT is enabled 12ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should use getUserMemory for system instruction when JIT is disabled 11ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should recursively call sendMessageStream with "Please continue." when InvalidStream event is received 12ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should not recursively call sendMessageStream with "Please continue." when InvalidStream event is received and flag is false 14ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should stop recursing after one retry when InvalidStream events are repeatedly received 14ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Editor context delta > 'sends delta when active file changes' 15ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Editor context delta > 'sends delta when cursor line changes' 14ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Editor context delta > 'sends delta when cursor character chaâ€¦' 13ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Editor context delta > 'sends delta when selected text changes' 13ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Editor context delta > 'sends delta when selected text is addâ€¦' 16ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Editor context delta > 'sends delta when selected text is remâ€¦' 15ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Editor context delta > 'does not send context when nothing châ€¦' 15ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Editor context delta > sends full context when history is cleared, even if editor state is unchanged 16ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Availability Service Integration > should select first available model, set active, and not consume sticky attempt (done lower in chain) 17ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Availability Service Integration > should default to last resort model if selection returns null 12ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Availability Service Integration > should reset turn on new message stream 8ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > Availability Service Integration > should NOT reset turn on invalid stream retry 11ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > IDE context with pending tool calls > should NOT add IDE context when a tool call is pending 18ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > IDE context with pending tool calls > should add IDE context when no tool call is pending 18ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > IDE context with pending tool calls > should send the latest IDE context on the next message after a skipped context 17ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > IDE context with pending tool calls > should send a context DELTA on the next message after a skipped context 18ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should not call checkNextSpeaker when turn.run() yields an error 19ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should not call checkNextSpeaker when turn.run() yields a value then an error 20ms
   âœ“ Gemini Client (client.ts) > sendMessageStream > should abort linked signal when loop is detected 20ms
   âœ“ Gemini Client (client.ts) > generateContent > should call generateContent with the correct parameters 22ms
   âœ“ Gemini Client (client.ts) > generateContent > should use current model from config for content generation 8ms
 âœ“ src/core/geminiChat_network_retry.test.ts (3 tests) 1017ms
   âœ“ GeminiChat Network Retries > should retry when a 503 ApiError occurs during stream iteration  511ms
   âœ“ GeminiChat Network Retries > should retry on generic network error if retryFetchErrors is true  502ms
 âœ“ src/services/fileDiscoveryService.test.ts (20 tests) 62ms
 âœ“ src/hooks/hookRunner.test.ts (19 tests) 94ms
 âœ“ src/tools/smart-edit.test.ts (24 tests) 179ms
 âœ“ src/policy/toml-loader.test.ts (25 tests) 87ms
 âœ“ src/utils/filesearch/crawler.test.ts (18 tests) 75ms
 âœ“ src/utils/terminalSerializer.test.ts (17 tests) 83ms
 âœ“ src/utils/fileUtils.test.ts (72 tests) 122ms
 âœ“ src/utils/getFolderStructure.test.ts (15 tests) 71ms
 âœ“ src/tools/glob.test.ts (37 tests) 1862ms
 âœ“ src/tools/memoryTool.test.ts (19 tests) 61ms
 âœ“ src/services/gitService.test.ts (17 tests) 77ms
 âœ“ src/core/logger.test.ts (39 tests) 154ms
 âœ“ src/tools/get-internal-docs.test.ts (4 tests) 64ms
 âœ“ src/ide/ide-client.test.ts (36 tests) 53ms
 âœ“ src/utils/shell-utils.test.ts (34 tests | 1 skipped) 94ms
 âœ“ src/agents/delegate-to-agent-tool.test.ts (8 tests) 56ms
 âœ“ src/policy/shell-safety.test.ts (5 tests) 88ms
 âœ“ src/policy/policy-engine.test.ts (60 tests) 70ms
 âœ“ src/telemetry/memory-monitor.test.ts (31 tests) 36ms
 âœ“ src/tools/message-bus-integration.test.ts (9 tests) 82ms
 âœ“ src/code_assist/experiments/client_metadata.test.ts (12 tests) 56ms
 âœ“ src/utils/gitIgnoreParser.test.ts (25 tests) 57ms
 âœ“ src/tools/web-fetch.test.ts (32 tests) 96ms
 âœ“ src/utils/schemaValidator.test.ts (7 tests) 45ms
 âœ“ src/telemetry/gcp-exporters.test.ts (18 tests) 46ms
 âœ“ src/utils/shell-permissions.test.ts (43 tests | 1 skipped) 106ms
 âœ“ src/utils/memoryImportProcessor.test.ts (25 tests) 44ms
 âœ“ src/utils/bfsFileSearch.test.ts (16 tests) 69ms
 âœ“ src/tools/process-manager.test.ts (4 tests) 137ms
 âœ“ src/agents/toml-loader.test.ts (13 tests) 51ms
 âœ“ src/code_assist/oauth2.test.ts (28 tests) 139ms
 âœ“ src/core/prompts.test.ts (41 tests) 57ms
 âœ“ src/utils/workspaceContext.test.ts (34 tests) 26ms
 âœ“ src/tools/tool-registry.test.ts (14 tests) 83ms
 âœ“ src/agents/local-executor.test.ts (32 tests) 98ms
 âœ“ src/tools/modifiable-tool.test.ts (12 tests) 49ms
 âœ“ src/safety/built-in.test.ts (14 tests) 69ms
 âœ“ src/mcp/google-auth-provider.test.ts (15 tests) 44ms
 âœ“ src/utils/environmentContext.test.ts (6 tests) 33ms
 âœ“ src/telemetry/loggers.test.ts (35 tests) 85ms
 âœ“ src/utils/userAccountManager.test.ts (23 tests) 50ms
 âœ“ src/utils/editor.test.ts (110 tests) 39ms
 âœ“ src/utils/events.test.ts (15 tests) 104ms
 âœ“ src/tools/write-todos.test.ts (9 tests) 56ms
 âœ“ src/utils/checkpointUtils.test.ts (15 tests) 23ms
 âœ“ src/hooks/hookRegistry.test.ts (19 tests) 23ms
 âœ“ src/safety/checker-runner.test.ts (9 tests) 31ms
 âœ“ src/utils/editCorrector.test.ts (40 tests) 38ms
 âœ“ src/utils/errorReporting.test.ts (6 tests) 26ms
 âœ“ src/policy/persistence.test.ts (5 tests) 20ms
 âœ“ src/services/sessionSummaryService.test.ts (33 tests) 49ms
 âœ“ src/mcp/oauth-token-storage.test.ts (28 tests) 29ms
 âœ“ src/hooks/hookSystem.test.ts (8 tests) 78ms
 âœ“ src/tools/web-search.test.ts (9 tests) 87ms
 âœ“ src/mcp/sa-impersonation-provider.test.ts (8 tests) 27ms
 âœ“ src/core/baseLlmClient.test.ts (29 tests) 62ms
 âœ“ src/mcp/oauth-utils.test.ts (31 tests) 26ms
 âœ“ src/utils/geminiIgnoreParser.test.ts (2 tests) 28ms
 âœ“ src/hooks/types.test.ts (35 tests) 23ms
 âœ“ src/core/contentGenerator.test.ts (16 tests) 45ms
 âœ“ src/utils/retry.test.ts (30 tests) 77ms
 âœ“ src/utils/systemEncoding.test.ts (38 tests) 20ms
 âœ“ src/code_assist/oauth-credential-storage.test.ts (16 tests) 26ms
(node:69472) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 SIGTERM listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(Use `node --trace-warnings ...` to show where the warning was created)
(node:69472) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 SIGINT listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
 âœ“ src/telemetry/sdk.test.ts (16 tests) 65ms
 âœ“ src/commands/restore.test.ts (6 tests) 18ms
 âœ“ src/code_assist/server.test.ts (19 tests) 66ms
 âœ“ src/agents/subagent-tool-wrapper.test.ts (7 tests) 56ms
 âœ“ src/output/stream-json-formatter.test.ts (20 tests) 16ms
 âœ“ src/ide/ideContext.test.ts (23 tests) 24ms
 âœ“ src/core/apiKeyCredentialStorage.test.ts (7 tests) 13ms
 âœ“ src/utils/summarizer.test.ts (8 tests) 72ms
 âœ“ src/ide/ide-installer.test.ts (15 tests) 25ms
 âœ“ src/mcp/token-storage/hybrid-token-storage.test.ts (11 tests) 29ms
 âœ“ src/routing/modelRouterService.test.ts (5 tests) 46ms
 âœ“ src/telemetry/activity-detector.test.ts (13 tests) 10ms
 âœ“ src/telemetry/high-water-mark-tracker.test.ts (18 tests) 15ms
 âœ“ src/utils/ignorePatterns.test.ts (28 tests) 25ms
 âœ“ src/services/modelConfigService.test.ts (26 tests) 14ms
 âœ“ src/utils/filesearch/ignore.test.ts (12 tests) 23ms
 âœ“ src/telemetry/startupProfiler.test.ts (22 tests) 38ms
 âœ“ src/services/modelConfig.golden.test.ts (2 tests) 12ms
 âœ“ src/hooks/hookTranslator.test.ts (10 tests) 11ms
 âœ“ src/core/loggingContentGenerator.test.ts (7 tests) 22ms
 âœ“ src/utils/paths.test.ts (88 tests | 17 skipped) 22ms
 âœ“ src/utils/nextSpeakerChecker.test.ts (10 tests) 25ms
 âœ“ src/services/chatRecordingService.test.ts (10 tests) 43ms
 âœ“ src/telemetry/rate-limiter.test.ts (24 tests) 15ms
 âœ“ src/tools/tools.test.ts (11 tests) 13ms
 âœ“ src/ide/process-utils.test.ts (8 tests) 7ms
 âœ“ src/core/geminiChat.test.ts (43 tests) 6736ms
   âœ“ GeminiChat > sendMessageStream > should fail if the stream ends with an empty part and has no finishReason  505ms
   âœ“ GeminiChat > sendMessageStream > should throw an error when a tool call is followed by an empty stream response  503ms
   âœ“ GeminiChat > sendMessageStream > should throw InvalidStreamError when no tool call and no finish reason  503ms
   âœ“ GeminiChat > sendMessageStream > should throw InvalidStreamError when no tool call and empty response text  504ms
   âœ“ GeminiChat > sendMessageStream > should throw InvalidStreamError when finishReason is MALFORMED_FUNCTION_CALL  503ms
   âœ“ GeminiChat > sendMessageStream > should retry when finishReason is MALFORMED_FUNCTION_CALL  505ms
   âœ“ GeminiChat > sendMessageStream with retries > should yield a RETRY event when an invalid stream is encountered  506ms
   âœ“ GeminiChat > sendMessageStream with retries > should retry on invalid content, succeed, and report metrics  507ms
   âœ“ GeminiChat > sendMessageStream with retries > should set temperature to 1 on retry  508ms
   âœ“ GeminiChat > sendMessageStream with retries > should fail after all retries on persistent invalid content and report metrics  506ms
   âœ“ GeminiChat > should correctly retry and append to an existing history mid-conversation  506ms
   âœ“ GeminiChat > should retry if the model returns a completely empty stream (no chunks)  506ms
   âœ“ GeminiChat > should discard valid partial content from a failed attempt upon retry  506ms
 âœ“ src/availability/policyHelpers.test.ts (12 tests) 16ms
 âœ“ src/prompts/prompt-registry.test.ts (7 tests) 18ms
 âœ“ src/agents/registry.test.ts (23 tests) 34ms
 âœ“ src/utils/llm-edit-fixer.test.ts (8 tests) 20ms
 âœ“ src/code_assist/experiments/experiments.test.ts (4 tests) 29ms
 âœ“ src/utils/secure-browser-launcher.test.ts (14 tests) 29ms
 âœ“ src/hooks/hookPlanner.test.ts (10 tests) 20ms
 âœ“ src/routing/strategies/compositeStrategy.test.ts (6 tests) 12ms
 âœ“ src/routing/strategies/classifierStrategy.test.ts (8 tests) 13ms
 âœ“ src/telemetry/telemetry.test.ts (2 tests) 19ms
 âœ“ src/utils/googleErrors.test.ts (13 tests) 14ms
 âœ“ src/services/sessionSummaryUtils.test.ts (10 tests) 26ms
 âœ“ src/tools/mcp-client-manager.test.ts (11 tests) 31ms
 âœ“ src/hooks/hookEventHandler.test.ts (10 tests) 35ms
 âœ“ src/ide/detect-ide.test.ts (15 tests) 5ms
 âœ“ src/hooks/hookAggregator.test.ts (10 tests) 13ms
 âœ“ src/confirmation-bus/message-bus.test.ts (10 tests) 17ms
 âœ“ src/telemetry/activity-monitor.test.ts (22 tests) 20ms
 âœ“ src/utils/pathCorrector.test.ts (4 tests) 14ms
 âœ“ src/services/contextManager.test.ts (4 tests) 11ms
 âœ“ src/config/models.test.ts (23 tests) 10ms
 âœ“ src/utils/filesearch/crawlCache.test.ts (9 tests) 11ms
 âœ“ src/utils/debugLogger.test.ts (6 tests) 10ms
 âœ“ src/core/fakeContentGenerator.test.ts (7 tests) 13ms
 âœ“ src/utils/googleQuotaErrors.test.ts (20 tests) 16ms
 âœ“ src/agents/utils.test.ts (12 tests) 15ms
 âœ“ src/core/nonInteractiveToolExecutor.test.ts (8 tests) 33ms
 âœ“ src/utils/delay.test.ts (7 tests) 25ms
 âœ“ src/availability/modelAvailabilityService.test.ts (9 tests) 6ms
 âœ“ src/code_assist/converter.test.ts (24 tests) 14ms
 âœ“ src/telemetry/semantic.test.ts (21 tests) 9ms
 âœ“ src/utils/generateContentResponseUtilities.test.ts (34 tests) 15ms
 âœ“ src/tools/base-tool-invocation.test.ts (2 tests) 9ms
 âœ“ src/fallback/handler.test.ts (14 tests) 37ms
 âœ“ src/utils/customHeaderUtils.test.ts (11 tests) 5ms
 âœ“ src/availability/policyCatalog.test.ts (10 tests) 6ms
 âœ“ src/agents/local-invocation.test.ts (11 tests) 18ms
 âœ“ src/services/fileSystemService.test.ts (3 tests) 10ms
 âœ“ src/output/json-formatter.test.ts (17 tests) 12ms
 âœ“ src/services/modelConfig.integration.test.ts (10 tests) 7ms
 âœ“ src/routing/strategies/fallbackStrategy.test.ts (4 tests) 7ms
 âœ“ src/core/recordingContentGenerator.test.ts (4 tests) 10ms
 âœ“ src/utils/channel.test.ts (22 tests) 12ms
 âœ“ src/agents/schema-utils.test.ts (6 tests) 10ms
 âœ“ src/utils/tokenCalculation.test.ts (7 tests) 5ms
 âœ“ src/utils/thoughtUtils.test.ts (11 tests) 5ms
 âœ“ src/safety/context-builder.test.ts (3 tests) 9ms
 âœ“ src/utils/errors.test.ts (15 tests) 9ms
 âœ“ src/utils/version.test.ts (3 tests) 5ms
 âœ“ src/tools/diffOptions.test.ts (9 tests) 16ms
 âœ“ src/utils/installationManager.test.ts (4 tests) 12ms
 âœ“ src/telemetry/uiTelemetry.test.ts (19 tests) 21ms
 âœ“ src/mcp/token-storage/base-token-storage.test.ts (12 tests) 7ms
 âœ“ src/safety/registry.test.ts (4 tests) 5ms
 âœ“ src/tools/tool-names.test.ts (5 tests) 6ms
 âœ“ src/utils/partUtils.test.ts (37 tests) 16ms
working stdoutworking stderr âœ“ src/utils/stdio.test.ts (2 tests) 10ms
 âœ“ src/routing/strategies/overrideStrategy.test.ts (3 tests) 4ms
 âœ“ src/agents/codebase-investigator.test.ts (2 tests) 5ms
 âœ“ src/prompts/mcp-prompts.test.ts (2 tests) 10ms
 âœ“ src/config/storage.test.ts (8 tests) 8ms
 âœ“ src/resources/resource-registry.test.ts (4 tests) 5ms
 âœ“ src/utils/safeJsonStringify.test.ts (8 tests) 5ms
 âœ“ src/telemetry/telemetry-utils.test.ts (6 tests) 3ms
 âœ“ src/core/turn.test.ts (21 tests) 27ms
 âœ“ src/core/tokenLimits.test.ts (5 tests) 6ms
 âœ“ src/utils/flashFallback.test.ts (4 tests) 13ms
 âœ“ src/utils/textUtils.test.ts (12 tests) 5ms
 âœ“ src/utils/formatters.test.ts (4 tests) 5ms
 âœ“ src/commands/extensions.test.ts (1 test) 5ms
 âœ“ src/utils/filesearch/result-cache.test.ts (3 tests) 7ms
 âœ“ src/commands/init.test.ts (2 tests) 5ms
 âœ“ src/index.test.ts (1 test) 5ms
 âœ“ src/routing/strategies/defaultStrategy.test.ts (1 test) 4ms
 âœ“ src/code_assist/codeAssist.test.ts (7 tests) 27ms
 âœ“ src/telemetry/sanitize.test.ts (18 tests) 12ms
 âœ“ src/code_assist/telemetry.test.ts (16 tests) 12ms
 âœ“ src/agents/remote-invocation.test.ts (2 tests) 4ms
 âœ“ src/agents/introspection-agent.test.ts (5 tests) 3ms
 âœ“ src/services/chatCompressionService.test.ts (17 tests) 10ms
 âœ“ src/code_assist/setup.test.ts (7 tests) 8ms
 âœ“ src/utils/extensionLoader.test.ts (9 tests | 1 skipped) 15ms
 âœ“ src/telemetry/config.test.ts (14 tests) 11ms
 âœ“ src/config/flashFallback.test.ts (2 tests) 4ms
 âœ“ src/utils/tool-utils.test.ts (8 tests) 4ms
 âœ“ src/utils/errorParsing.test.ts (10 tests) 4ms
 âœ“ src/telemetry/metrics.test.ts (68 tests) 15131ms
   âœ“ Telemetry Metrics > recordFlickerFrame > does not record metrics if not initialized  648ms
   âœ“ Telemetry Metrics > recordFlickerFrame > records a flicker frame event when initialized  558ms
   âœ“ Telemetry Metrics > recordExitFail > does not record metrics if not initialized  730ms
   âœ“ Telemetry Metrics > recordExitFail > records a exit fail event when initialized  676ms
   âœ“ Telemetry Metrics > recordSlowRender > does not record metrics if not initialized  702ms
   âœ“ Telemetry Metrics > recordSlowRender > records a slow render event when initialized  752ms
   âœ“ Telemetry Metrics > initializeMetrics > should apply common attributes including email  620ms
   âœ“ Telemetry Metrics > recordChatCompressionMetrics > does not record metrics if not initialized  617ms
   âœ“ Telemetry Metrics > recordChatCompressionMetrics > records token compression with the correct attributes  628ms
   âœ“ Telemetry Metrics > recordTokenUsageMetrics > should not record metrics if not initialized  784ms
   âœ“ Telemetry Metrics > recordTokenUsageMetrics > should record token usage for 'input' type with 100 tokens for model 'gemini-pro'  746ms
   âœ“ Telemetry Metrics > recordTokenUsageMetrics > should record token usage for 'output' type with 50 tokens for model 'gemini-pro'  817ms
   âœ“ Telemetry Metrics > recordTokenUsageMetrics > should record token usage for 'thought' type with 25 tokens for model 'gemini-pro'  871ms
   âœ“ Telemetry Metrics > recordTokenUsageMetrics > should record token usage for 'cache' type with 75 tokens for model 'gemini-pro'  764ms
   âœ“ Telemetry Metrics > recordTokenUsageMetrics > should record token usage for 'tool' type with 125 tokens for model 'gemini-pro'  638ms

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 1 â¯â¯â¯â¯â¯â¯â¯

 FAIL  src/core/client.test.ts > Gemini Client (client.ts) > startChat > should include environment context when resuming a session
AssertionError: expected 'This is TermAI, a general terminal agâ€¦' to contain 'This is the Gemini CLI'

[32m- Expected[39m
[31m+ Received[39m

[32m- This is [7mthe Gemini CLI[27m[39m
[31m+ This is [7mTermAI, a general terminal agent. We are setting up the context for our chat.[27m[39m
[31m+ Today's date is Saturday, December 20, 2025 (formatted according to the user's locale).[39m
[31m+ My operating system is: linux[39m
[31m+ The project's temporary directory is: /test/temp[39m
[31m+ ## Current System State[39m
[31m+ - OS: linux 6.14.0-37-generic[39m
[31m+ - CPU: 20 cores, load (1m): 9.81[39m
[31m+ - RAM: 14 GB used of 31 GB (45.4%)[39m
[31m+ - Disk: Run 'df -h' for details if needed.[39m
[31m+ I'm currently working in the directory: /test/dir[39m
[31m+ Here is the folder structure of the current working directories:[39m
[31m+[39m
[31m+ Reminder: Do not return an empty response when a tool call is required.[39m
[31m+[39m
[31m+ My setup is complete. I will provide my first command in the next turn.[39m

 â¯ src/core/client.test.ts:345:43
    343|       // The first message should be the environment context
    344|       expect(history[0].role).toBe('user');
    345|       expect(history[0].parts?.[0]?.text).toContain('This is the Geminâ€¦
       |                                           ^
    346|       expect(history[0].parts?.[0]?.text).toContain(
    347|         "The project's temporary directory is:",

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯


 Test Files  1 failed | 201 passed (202)
      Tests  1 failed | 3717 passed | 24 skipped (3742)
   Start at  07:09:52
   Duration  19.99s (transform 9.14s, setup 2.48s, collect 161.36s, tests 39.19s, environment 52ms, prepare 20.04s)

JUNIT report written to /home/profharita/Code/termAI/packages/core/junit.xml
npm error Lifecycle script `test:ci` failed with error:
npm error code 1
npm error path /home/profharita/Code/termAI/packages/core
npm error workspace @google/gemini-cli-core@0.21.0-nightly.20251219.70696e364
npm error location /home/profharita/Code/termAI/packages/core
npm error command failed
npm error command sh -c vitest run
