
> @google/gemini-cli-a2a-server@0.21.0-nightly.20251219.70696e364 test
> vitest run src/http/app.test.ts


 RUN  v3.2.4 /home/profharita/Code/termAI/packages/a2a-server
      Coverage enabled with v8

 â¯ src/http/app.test.ts (19 tests | 16 failed) 75ms
   Ã— E2E Tests > should create a new task and stream status updates (text-content) via POST / 28ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should create a new task, schedule a tool call, and wait for approval 3ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should handle multiple tool calls in a single turn 2ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should handle multiple tool calls sequentially in YOLO mode 2ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should handle tool calls that do not require approval 2ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should bypass tool approval in YOLO mode 2ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should include traceId in status updates when available 1ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   âœ“ E2E Tests > /listCommands > should return a list of top-level commands 4ms
   âœ“ E2E Tests > /listCommands > should handle cyclic commands gracefully 2ms
   Ã— E2E Tests > /executeCommand > should return extensions for valid command 5ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > /executeCommand > should return 404 for invalid command 2ms
     â†’ expected 404 "Not Found", got 500 "Internal Server Error"
   Ã— E2E Tests > /executeCommand > should return 400 for missing command 2ms
     â†’ expected 400 "Bad Request", got 500 "Internal Server Error"
   Ã— E2E Tests > /executeCommand > should return 400 if args is not an array 1ms
     â†’ expected 400 "Bad Request", got 500 "Internal Server Error"
   Ã— E2E Tests > /executeCommand > should execute a command that does not require a workspace when CODER_AGENT_WORKSPACE_PATH is not set 3ms
     â†’ expected 500 to be 200 // Object.is equality
   Ã— E2E Tests > /executeCommand > should return 400 for a command that requires a workspace when CODER_AGENT_WORKSPACE_PATH is not set 1ms
     â†’ expected 500 to be 400 // Object.is equality
   Ã— E2E Tests > /executeCommand > should execute a command that requires a workspace when CODER_AGENT_WORKSPACE_PATH is set 1ms
     â†’ expected 500 to be 200 // Object.is equality
   Ã— E2E Tests > /executeCommand > should include agentExecutor in context 1ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   âœ“ E2E Tests > /executeCommand > /executeCommand streaming > should execute a streaming command and stream back events 0ms
   Ã— E2E Tests > /executeCommand > /executeCommand streaming > should handle non-streaming commands gracefully 2ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"

â¯â¯â¯â¯â¯â¯ Failed Tests 16 â¯â¯â¯â¯â¯â¯â¯

 FAIL  src/http/app.test.ts > E2E Tests > should create a new task and stream status updates (text-content) via POST /
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:148:8
    146|       .set('Content-Type', 'application/json')
    147|       .send(body)
    148|       .expect(200);
       |        ^
    149| 
    150|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should create a new task, schedule a tool call, and wait for approval
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:215:8
    213|       .set('Content-Type', 'application/json')
    214|       .send(body)
    215|       .expect(200);
       |        ^
    216| 
    217|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should handle multiple tool calls in a single turn
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:322:8
    320|       .set('Content-Type', 'application/json')
    321|       .send(body)
    322|       .expect(200);
       |        ^
    323| 
    324|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should handle multiple tool calls sequentially in YOLO mode
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:481:8
    479|       .set('Content-Type', 'application/json')
    480|       .send(body)
    481|       .expect(200);
       |        ^
    482| 
    483|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should handle tool calls that do not require approval
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:603:8
    601|       .set('Content-Type', 'application/json')
    602|       .send(body)
    603|       .expect(200);
       |        ^
    604| 
    605|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should bypass tool approval in YOLO mode
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:734:8
    732|       .set('Content-Type', 'application/json')
    733|       .send(body)
    734|       .expect(200);
       |        ^
    735| 
    736|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should include traceId in status updates when available
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:834:8
    832|       .set('Content-Type', 'application/json')
    833|       .send(body)
    834|       .expect(200);
       |        ^
    835| 
    836|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should return extensions for valid command
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:982:10
    980|         .set('Content-Type', 'application/json')
    981|         .send(body)
    982|         .expect(200);
       |          ^
    983| 
    984|       expect(res.body).toEqual({
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[8/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should return 404 for invalid command
Error: expected 404 "Not Found", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:1001:10
    999|         .set('Content-Type', 'application/json')
    1000|         .send(body)
    1001|         .expect(404);
       |          ^
    1002| 
    1003|       expect(res.body.error).toBe('Command not found: invalid command'â€¦
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[9/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should return 400 for missing command
Error: expected 400 "Bad Request", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:1015:10
    1013|         .set('Content-Type', 'application/json')
    1014|         .send(body)
    1015|         .expect(400);
       |          ^
    1016|       expect(getExtensionsSpy).not.toHaveBeenCalled();
    1017|     });
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[10/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should return 400 if args is not an array
Error: expected 400 "Bad Request", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:1027:10
    1025|         .set('Content-Type', 'application/json')
    1026|         .send(body)
    1027|         .expect(400);
       |          ^
    1028| 
    1029|       expect(res.body.error).toBe('"args" field must be an array.');
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[11/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should execute a command that does not require a workspace when CODER_AGENT_WORKSPACE_PATH is not set
AssertionError: expected 500 to be 200 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

 â¯ src/http/app.test.ts:1051:31
    1049|         .send(body);
    1050| 
    1051|       expect(response.status).toBe(200);
       |                               ^
    1052|       expect(response.body.data).toBe('success');
    1053|     });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[12/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should return 400 for a command that requires a workspace when CODER_AGENT_WORKSPACE_PATH is not set
AssertionError: expected 500 to be 400 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 500[39m

 â¯ src/http/app.test.ts:1074:31
    1072|         .send(body);
    1073| 
    1074|       expect(response.status).toBe(400);
       |                               ^
    1075|       expect(response.body.error).toBe(
    1076|         'Command "workspace-command" requires a workspace, but CODER_Aâ€¦

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[13/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should execute a command that requires a workspace when CODER_AGENT_WORKSPACE_PATH is set
AssertionError: expected 500 to be 200 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

 â¯ src/http/app.test.ts:1099:31
    1097|         .send(body);
    1098| 
    1099|       expect(response.status).toBe(200);
       |                               ^
    1100|       expect(response.body.data).toBe('success');
    1101|     });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[14/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should include agentExecutor in context
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:1123:10
    1121|         .set('Content-Type', 'application/json')
    1122|         .send(body)
    1123|         .expect(200);
       |          ^
    1124| 
    1125|       expect(res.body.data).toBe('success');
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[15/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > /executeCommand streaming > should handle non-streaming commands gracefully
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:1216:12
    1214|           .set('Content-Type', 'application/json')
    1215|           .send(body)
    1216|           .expect(200);
       |            ^
    1217| 
    1218|         expect(res.body).toEqual({ name: 'non-stream-test', data: 'donâ€¦
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[16/16]â¯


 Test Files  1 failed (1)
      Tests  16 failed | 3 passed (19)
   Start at  18:10:16
   Duration  2.10s (transform 615ms, setup 0ms, collect 1.58s, tests 75ms, environment 0ms, prepare 61ms)

JUNIT report written to /home/profharita/Code/termAI/packages/a2a-server/junit.xml
npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /home/profharita/Code/termAI/packages/a2a-server
npm error workspace @google/gemini-cli-a2a-server@0.21.0-nightly.20251219.70696e364
npm error location /home/profharita/Code/termAI/packages/a2a-server
npm error command failed
npm error command sh -c vitest run src/http/app.test.ts
