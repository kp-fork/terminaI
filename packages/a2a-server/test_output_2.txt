
> @google/gemini-cli-a2a-server@0.21.0-nightly.20251219.70696e364 test
> vitest run src/http/app.test.ts


 RUN  v3.2.4 /home/profharita/Code/termAI/packages/a2a-server
      Coverage enabled with v8

 â¯ src/http/app.test.ts (19 tests | 16 failed) 63ms
   Ã— E2E Tests > should create a new task and stream status updates (text-content) via POST / 23ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should create a new task, schedule a tool call, and wait for approval 2ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should handle multiple tool calls in a single turn 2ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should handle multiple tool calls sequentially in YOLO mode 2ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should handle tool calls that do not require approval 2ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should bypass tool approval in YOLO mode 1ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > should include traceId in status updates when available 1ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   âœ“ E2E Tests > /listCommands > should return a list of top-level commands 3ms
   âœ“ E2E Tests > /listCommands > should handle cyclic commands gracefully 2ms
   Ã— E2E Tests > /executeCommand > should return extensions for valid command 6ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   Ã— E2E Tests > /executeCommand > should return 404 for invalid command 2ms
     â†’ expected 404 "Not Found", got 500 "Internal Server Error"
   Ã— E2E Tests > /executeCommand > should return 400 for missing command 1ms
     â†’ expected 400 "Bad Request", got 500 "Internal Server Error"
   Ã— E2E Tests > /executeCommand > should return 400 if args is not an array 1ms
     â†’ expected 400 "Bad Request", got 500 "Internal Server Error"
   Ã— E2E Tests > /executeCommand > should execute a command that does not require a workspace when CODER_AGENT_WORKSPACE_PATH is not set 3ms
     â†’ expected 500 to be 200 // Object.is equality
   Ã— E2E Tests > /executeCommand > should return 400 for a command that requires a workspace when CODER_AGENT_WORKSPACE_PATH is not set 1ms
     â†’ expected 500 to be 400 // Object.is equality
   Ã— E2E Tests > /executeCommand > should execute a command that requires a workspace when CODER_AGENT_WORKSPACE_PATH is set 1ms
     â†’ expected 500 to be 200 // Object.is equality
   Ã— E2E Tests > /executeCommand > should include agentExecutor in context 1ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"
   âœ“ E2E Tests > /executeCommand > /executeCommand streaming > should execute a streaming command and stream back events 0ms
   Ã— E2E Tests > /executeCommand > /executeCommand streaming > should handle non-streaming commands gracefully 2ms
     â†’ expected 200 "OK", got 500 "Internal Server Error"

â¯â¯â¯â¯â¯â¯ Failed Tests 16 â¯â¯â¯â¯â¯â¯â¯

 FAIL  src/http/app.test.ts > E2E Tests > should create a new task and stream status updates (text-content) via POST /
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:157:8
    155|         }
    156|       })
    157|       .expect(200);
       |        ^
    158| 
    159|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should create a new task, schedule a tool call, and wait for approval
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:224:8
    222|       .set('Content-Type', 'application/json')
    223|       .send(body)
    224|       .expect(200);
       |        ^
    225| 
    226|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should handle multiple tool calls in a single turn
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:331:8
    329|       .set('Content-Type', 'application/json')
    330|       .send(body)
    331|       .expect(200);
       |        ^
    332| 
    333|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should handle multiple tool calls sequentially in YOLO mode
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:490:8
    488|       .set('Content-Type', 'application/json')
    489|       .send(body)
    490|       .expect(200);
       |        ^
    491| 
    492|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should handle tool calls that do not require approval
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:612:8
    610|       .set('Content-Type', 'application/json')
    611|       .send(body)
    612|       .expect(200);
       |        ^
    613| 
    614|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should bypass tool approval in YOLO mode
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:743:8
    741|       .set('Content-Type', 'application/json')
    742|       .send(body)
    743|       .expect(200);
       |        ^
    744| 
    745|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > should include traceId in status updates when available
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:843:8
    841|       .set('Content-Type', 'application/json')
    842|       .send(body)
    843|       .expect(200);
       |        ^
    844| 
    845|     const events = streamToSSEEvents(res.text);
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should return extensions for valid command
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:991:10
    989|         .set('Content-Type', 'application/json')
    990|         .send(body)
    991|         .expect(200);
       |          ^
    992| 
    993|       expect(res.body).toEqual({
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[8/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should return 404 for invalid command
Error: expected 404 "Not Found", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:1010:10
    1008|         .set('Content-Type', 'application/json')
    1009|         .send(body)
    1010|         .expect(404);
       |          ^
    1011| 
    1012|       expect(res.body.error).toBe('Command not found: invalid command'â€¦
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[9/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should return 400 for missing command
Error: expected 400 "Bad Request", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:1024:10
    1022|         .set('Content-Type', 'application/json')
    1023|         .send(body)
    1024|         .expect(400);
       |          ^
    1025|       expect(getExtensionsSpy).not.toHaveBeenCalled();
    1026|     });
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[10/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should return 400 if args is not an array
Error: expected 400 "Bad Request", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:1036:10
    1034|         .set('Content-Type', 'application/json')
    1035|         .send(body)
    1036|         .expect(400);
       |          ^
    1037| 
    1038|       expect(res.body.error).toBe('"args" field must be an array.');
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[11/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should execute a command that does not require a workspace when CODER_AGENT_WORKSPACE_PATH is not set
AssertionError: expected 500 to be 200 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

 â¯ src/http/app.test.ts:1060:31
    1058|         .send(body);
    1059| 
    1060|       expect(response.status).toBe(200);
       |                               ^
    1061|       expect(response.body.data).toBe('success');
    1062|     });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[12/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should return 400 for a command that requires a workspace when CODER_AGENT_WORKSPACE_PATH is not set
AssertionError: expected 500 to be 400 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 500[39m

 â¯ src/http/app.test.ts:1083:31
    1081|         .send(body);
    1082| 
    1083|       expect(response.status).toBe(400);
       |                               ^
    1084|       expect(response.body.error).toBe(
    1085|         'Command "workspace-command" requires a workspace, but CODER_Aâ€¦

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[13/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should execute a command that requires a workspace when CODER_AGENT_WORKSPACE_PATH is set
AssertionError: expected 500 to be 200 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

 â¯ src/http/app.test.ts:1108:31
    1106|         .send(body);
    1107| 
    1108|       expect(response.status).toBe(200);
       |                               ^
    1109|       expect(response.body.data).toBe('success');
    1110|     });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[14/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > should include agentExecutor in context
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:1132:10
    1130|         .set('Content-Type', 'application/json')
    1131|         .send(body)
    1132|         .expect(200);
       |          ^
    1133| 
    1134|       expect(res.body.data).toBe('success');
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[15/16]â¯

 FAIL  src/http/app.test.ts > E2E Tests > /executeCommand > /executeCommand streaming > should handle non-streaming commands gracefully
Error: expected 200 "OK", got 500 "Internal Server Error"
 â¯ src/http/app.test.ts:1225:12
    1223|           .set('Content-Type', 'application/json')
    1224|           .send(body)
    1225|           .expect(200);
       |            ^
    1226| 
    1227|         expect(res.body).toEqual({ name: 'non-stream-test', data: 'donâ€¦
 â¯ Test._assertStatus ../../node_modules/supertest/lib/test.js:309:14
 â¯ ../../node_modules/supertest/lib/test.js:365:13
 â¯ Test._assertFunction ../../node_modules/supertest/lib/test.js:342:13
 â¯ Test.assert ../../node_modules/supertest/lib/test.js:195:23
 â¯ localAssert ../../node_modules/supertest/lib/test.js:138:14
 â¯ fn ../../node_modules/supertest/lib/test.js:156:7
 â¯ Test.callback ../../node_modules/superagent/src/node/index.js:904:3
 â¯ IncomingMessage.<anonymous> ../../node_modules/superagent/src/node/index.js:1183:18

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[16/16]â¯


 Test Files  1 failed (1)
      Tests  16 failed | 3 passed (19)
   Start at  18:11:53
   Duration  1.90s (transform 557ms, setup 0ms, collect 1.44s, tests 63ms, environment 0ms, prepare 48ms)

JUNIT report written to /home/profharita/Code/termAI/packages/a2a-server/junit.xml
npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /home/profharita/Code/termAI/packages/a2a-server
npm error workspace @google/gemini-cli-a2a-server@0.21.0-nightly.20251219.70696e364
npm error location /home/profharita/Code/termAI/packages/a2a-server
npm error command failed
npm error command sh -c vitest run src/http/app.test.ts
